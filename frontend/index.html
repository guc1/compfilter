<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Compfilter ‚Äî prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/styles.css" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <header class="hero card">
      <div class="hero-text">
        <h1>Compfilter (prototype)</h1>
        <p class="lead">Streamlined filtering for millions of CSV rows ‚Äî select exactly what you need, preview instantly, and download on demand.</p>
      </div>
      <div class="hero-tags">
        <span class="hero-chip">‚ö° Streaming safe</span>
        <span class="hero-chip">üß≠ Geo-ready</span>
        <span class="hero-chip">üõ°Ô∏è Local-first</span>
      </div>
    </header>

    <section id="dashboard" class="card glass">
      <div class="card-header">
        <div>
          <h2 class="h2">Filters</h2>
          <p class="card-subtitle">Open a filter to refine your dataset. Every change updates the summary below.</p>
        </div>
      </div>
      <div id="filterButtons" class="btn-grid"></div>

      <div id="activeSummary" class="summary"></div>

      <div class="actions">
        <button id="previewBtn" class="btn secondary">
          <span class="btn-icon" aria-hidden="true">üëÅÔ∏è</span>
          <span>Preview count</span>
        </button>
        <span id="previewOut" class="muted preview-indicator"></span>
        <button id="downloadBtn" class="btn primary">
          <span class="btn-icon" aria-hidden="true">‚¨áÔ∏è</span>
          <span>Download CSV</span>
        </button>
        <button id="customSaveToggle" class="btn ghost">
          <span class="btn-icon" aria-hidden="true">üíæ</span>
          <span>Custom save‚Ä¶</span>
        </button>
      </div>

      <div id="customSavePanel" class="custom-save hidden">
        <div class="custom-save-grid">
          <label class="custom-save-field">
            <span class="label">Save directory</span>
            <input id="customSavePath" type="text" placeholder="/path/to/folder" />
          </label>
          <label class="custom-save-field">
            <span class="label">Base filename</span>
            <input id="customBaseName" type="text" placeholder="results" />
          </label>
          <label class="custom-save-field">
            <span class="label">Max rows per file</span>
            <input id="customMaxRows" type="number" min="1" step="1" placeholder="50000" />
          </label>
          <div class="custom-save-field estimate">
            <span class="label">Estimated files</span>
            <div id="customFileEstimate" class="muted">Enter max rows to estimate.</div>
          </div>
        </div>
        <div class="custom-save-actions">
          <button id="customSaveRun" class="btn primary">Save files</button>
          <span id="customSaveStatus" class="muted smallprint"></span>
        </div>
      </div>
    </section>

    <section id="panel" class="card panel hidden glass">
      <div class="panel-header">
        <button id="backBtn" class="btn ghost" type="button">‚Üê Back</button>
        <h3 id="panelTitle"></h3>
        <div class="panel-hint muted">Selections save automatically when you click ‚ÄúSave selection‚Äù.</div>
      </div>
      <div id="aoiUploaderContainer" class="panel-section hidden">
        <h4 class="panel-section-title">Custom area (GeoJSON, EPSG:4326)</h4>
        <div class="panel-section-body">
          <div class="grid two">
            <input id="aoiFile" type="file" accept=".geojson,application/geo+json" />
            <button id="aoiUploadBtn" class="btn secondary" type="button">Upload</button>
          </div>
          <p class="muted smallprint">After upload, your area appears in the list as <em>custom:&lt;filename&gt;</em>. Tick it and save to apply, or use Remove to delete it.</p>
        </div>
      </div>
      <div class="panel-body">
        <div id="panelOptions" class="panel-options"></div>
      </div>
      <div class="panel-actions">
        <button id="saveBtn" class="btn primary">Save selection</button>
        <span id="panelHint" class="muted"></span>
      </div>
    </section>
  </div>

  <!-- Try external script first -->
  <script src="/script.js?v=rev7"></script>

  <!-- Inline fallback if external didn't boot -->
  <script>
  (function(){
    if (window.__CompfilterBooted) return;

    const $ = (sel) => document.querySelector(sel);
    const API = (path) => `${location.origin}${path}`;

    let FILTERS_META = [];
    let FILTER_OPTIONS = {};
    let SELECTED = {};
    let ACTIVE_KEY = null;
    let LAST_PREVIEW_COUNT = null;

    function getMeta(key){ return FILTERS_META.find(f=>f.key===key) || {key, label:key, type:"multiselect"}; }

    function summarizeSelection(key){
      const meta = getMeta(key);
      const sel = SELECTED[key] || [];
      if(meta.type==="number"){
        const mn = sel[0] ?? "";
        const mx = sel[1] ?? "";
        if(!mn && !mx) return "x";
        if(mn && mx) return `${mn}‚Äì${mx}`;
        if(mn) return `‚â• ${mn}`;
        return `‚â§ ${mx}`;
      }
      if(meta.type==="group"){
        if(key==='overige'){
          const tn = sel.find(t=>t==='tn=TRUE'||t==='tn=FALSE');
          const dmin = (sel.find(t=>t.startsWith('date_min='))||'').split('=')[1]||'';
          const dmax = (sel.find(t=>t.startsWith('date_max='))||'').split('=')[1]||'';
          const parts=[];
          if(tn) parts.push(tn.replace('tn=','tn:'));
          if(dmin||dmax) parts.push(dmin&&dmax?`date:${dmin}‚Äì${dmax}`:(dmin?`date:‚â• ${dmin}`:`date:‚â§ ${dmax}`));
          return parts.length?parts.join(' ¬∑ '):'x';
        }
        // vestiging summary
        const gd = sel.filter(t => t.startsWith("gd=")).length;
        const hv = sel.find(t => t==="hv=TRUE" || t==="hv=FALSE");
        const nm = sel.find(t => t==="nm=TRUE" || t==="nm=FALSE");
        const omin = sel.find(t => t.startsWith("oppmin="));
        const omax = sel.find(t => t.startsWith("oppmax="));
        const parts = [];
        if(gd>0) parts.push(`gd:${gd}`);
        if(hv) parts.push(hv.replace("hv=","hv:"));
        if(nm) parts.push(nm.replace("nm=","nm:"));
        if(omin || omax){
          const a = omin ? omin.split("=")[1] : "";
          const b = omax ? omax.split("=")[1] : "";
          parts.push(a && b ? `opp:${a}‚Äì${b}` : (a ? `opp:‚â• ${a}` : `opp:‚â§ ${b}`));
        }
        return parts.length ? parts.join(" ¬∑ ") : "x";
      }
      return `${sel.length} selected`;
    }

    function renderDashboard(){
      const btnHost=$("#filterButtons"); btnHost.innerHTML="";
      FILTERS_META.forEach(f=>{
        const btn=document.createElement("button");
        btn.className="filter-btn";
        btn.dataset.key=f.key;
        const detail = summarizeSelection(f.key);
        btn.innerHTML=`<span>${f.label}</span><span class="badge">${detail}</span>`;
        btn.addEventListener("click",()=>openPanel(f.key));
        btnHost.appendChild(btn);
      });

      const s=$("#activeSummary");
      const chips = [];
      Object.entries(SELECTED).forEach(([k,v])=>{
        if(!v || v.length===0) return;
        const meta = getMeta(k);
        chips.push(`<span class="chip" data-key="${k}">${meta.label}: ${summarizeSelection(k)}<button class="chip-x" data-clearkey="${k}" title="Clear">√ó</button></span>`);
      });
      const hasAny = chips.length>0;
      s.innerHTML = `<div class="chips">${chips.join(" ")}${hasAny ? '<button class="chip clear-all" id="clearAllBtn">Clear all</button>' : ''}</div>`;
    }

    function openPanel(key){
      // toggle behavior
      const panelEl = document.getElementById("panel");
      if (ACTIVE_KEY === key && panelEl && !panelEl.classList.contains("hidden")) {
        closePanel(false);
        return;
      }

      ACTIVE_KEY=key;
      const meta=getMeta(key);
      $("#panelTitle").textContent=meta.label;
      const host=$("#panelOptions");
      host.innerHTML="";

      if(meta.type==="number"){
        const current = SELECTED[key] || [];
        const curMin = current[0] || "";
        const curMax = current[1] || "";
        const wrap=document.createElement("div");
        wrap.innerHTML=`
          <div class="group">
            <label class="checkbox" style="display:block"><span>Enter working number range (employees). Use 'x' or leave blank to ignore a side.</span></label>
          </div>
          <div class="grid" style="grid-template-columns:1fr 1fr;">
            <div>
              <div class="muted" style="margin-bottom:4px;">Min</div>
              <input id="wnumMin" type="text" inputmode="numeric" pattern="[0-9xX]*" placeholder="x" value="${curMin}">
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;">Max</div>
              <input id="wnumMax" type="text" inputmode="numeric" pattern="[0-9xX]*" placeholder="x" value="${curMax}">
            </div>
          </div>
        `;
        host.appendChild(wrap);
        $("#panelHint").textContent="Row kept if [row_min,row_max] overlaps your [Min, Max]. 999999999 is treated as ‚àû.";
      } else if (meta.type==="group") {
        if (key === 'overige') {
          const current = new Set(SELECTED[key]||[]);
          const wrap=document.createElement('div');
          wrap.innerHTML = `
            <div class="card" style="padding:12px;">
              <div class="muted" style="margin-bottom:6px;">Oprichtingsdatum</div>
              <div class="grid" style="grid-template-columns:1fr 1fr;">
                <div>
                  <div class="muted" style="margin-bottom:4px;">Min</div>
                  <input id="dateMin" type="date" value="${(Array.from(current).find(t=>t.startsWith('date_min='))||'').split('=')[1]||''}">
                </div>
                <div>
                  <div class="muted" style="margin-bottom:4px;">Max</div>
                  <input id="dateMax" type="date" value="${((Array.from(current).find(t=>t.startsWith('date_max='))||'').split('=')[1]||'')}">
                </div>
              </div>
            </div>
            <div class="card" style="padding:12px;">
              <div class="muted" style="margin-bottom:6px;">Tradenames</div>
              <label class="checkbox"><input type="checkbox" class="panel-opt-bool" data-token="tn=TRUE" ${current.has('tn=TRUE')?'checked':''}> TRUE</label>
              <label class="checkbox"><input type="checkbox" class="panel-opt-bool" data-token="tn=FALSE" ${current.has('tn=FALSE')?'checked':''}> FALSE</label>
              <div class="muted" style="font-size:12px; margin-top:6px;">(Pick both to ignore)</div>
            </div>
          `;
          host.appendChild(wrap);
          document.getElementById('panelHint').textContent = 'Pick date range and/or tradenames presence. Save selection to apply.';
        } else {
          // VESTIGING
          const options = FILTER_OPTIONS[key] || [];
          const current = new Set(SELECTED[key] || []);

          const toolbar=document.createElement("div");
          toolbar.className="mini-actions";
          toolbar.innerHTML = `
            <strong>Gebruiksdoel</strong>
            <div class="spacer"></div>
            <button id="selectAllBtn" type="button">Select all</button>
            <button id="clearAllBtn" type="button">Clear</button>
          `;
          host.appendChild(toolbar);

          const gdWrap=document.createElement("div");
          gdWrap.className="grid";
          options.forEach(opt=>{
            const token = "gd=" + opt;
            const id = `gd__${opt.replace(/\s+/g,'_')}`;
            const wrap=document.createElement("label"); wrap.className="checkbox";
            wrap.innerHTML = `<input type="checkbox" class="panel-opt-gd" id="${id}" ${current.has(token)?'checked':''} data-token="${token}"> <span>${opt}</span>`;
            gdWrap.appendChild(wrap);
          });
          host.appendChild(gdWrap);

          const bools=document.createElement("div");
          bools.className="grid";
          bools.style.gridTemplateColumns="repeat(auto-fill,minmax(220px,1fr))";
          bools.innerHTML = `
            <div class="card" style="padding:12px;">
              <div class="muted" style="margin-bottom:6px;">Hoofdvestiging</div>
              <label class="checkbox"><input type="checkbox" class="panel-opt-bool" data-token="hv=TRUE" ${current.has("hv=TRUE")?'checked':''}> TRUE</label>
              <label class="checkbox"><input type="checkbox" class="panel-opt-bool" data-token="hv=FALSE" ${current.has("hv=FALSE")?'checked':''}> FALSE</label>
              <div class="muted" style="font-size:12px; margin-top:6px;">(Pick both to ignore)</div>
            </div>
            <div class="card" style="padding:12px;">
              <div class="muted" style="margin-bottom:6px;">KVK non-mailing</div>
              <label class="checkbox"><input type="checkbox" class="panel-opt-bool" data-token="nm=TRUE" ${current.has("nm=TRUE")?'checked':''}> TRUE</label>
              <label class="checkbox"><input type="checkbox" class="panel-opt-bool" data-token="nm=FALSE" ${current.has("nm=FALSE")?'checked':''}> FALSE</label>
              <div class="muted" style="font-size:12px; margin-top:6px;">(Pick both to ignore)</div>
            </div>
            <div class="card" style="padding:12px;">
              <div class="muted" style="margin-bottom:6px;">Oppervlakte verblijfsobject</div>
              <div class="grid" style="grid-template-columns:1fr 1fr;">
                <div>
                  <div class="muted" style="margin-bottom:4px;">Min</div>
                  <input id="oppMin" type="text" inputmode="numeric" pattern="[0-9xX]*" placeholder="x" value="${(Array.from(current).find(t=>t.startsWith('oppmin='))||'').split('=')[1]||''}">
                </div>
                <div>
                  <div class="muted" style="margin-bottom:4px;">Max</div>
                  <input id="oppMax" type="text" inputmode="numeric" pattern="[0-9xX]*" placeholder="x" value="${(Array.from(current).find(t=>t.startsWith('oppmax='))||'').split('=')[1]||''}">
                </div>
              </div>
              <div class="muted" style="font-size:12px; margin-top:6px;">Leave blank/x to ignore a side.</div>
            </div>
          `;
          host.appendChild(bools);

          toolbar.querySelector("#selectAllBtn").addEventListener("click", ()=>{
            host.querySelectorAll("input.panel-opt-gd").forEach(ch => ch.checked = true);
          });
          toolbar.querySelector("#clearAllBtn").addEventListener("click", ()=>{
            host.querySelectorAll("input.panel-opt-gd").forEach(ch => ch.checked = false);
          });

          $("#panelHint").textContent="Pick gebruiksdoel + flags + range as needed. Save selection to apply.";
        }
      } else {
        // default multiselect
        const toolbar=document.createElement("div");
        toolbar.className="mini-actions";
        toolbar.innerHTML = `
          <strong>Quick actions</strong>
          <div class="spacer"></div>
          <button id="selectAllBtn" type="button">Select all</button>
          <button id="clearAllBtn" type="button">Clear</button>
        `;
        host.appendChild(toolbar);

        const optionsWrap=document.createElement("div");
        optionsWrap.className="grid";
        const options=FILTER_OPTIONS[key]||[];
        const selected=new Set(SELECTED[key]||[]);
        options.forEach(opt=>{
          const id = `${key}__${opt.replace(/\s+/g,'_')}`;
          const wrap=document.createElement("label"); wrap.className="checkbox";
          wrap.innerHTML = `<input type="checkbox" class="panel-opt" id="${id}" ${selected.has(opt)?'checked':''} data-value="${opt}"> <span>${opt}</span>`;
          optionsWrap.appendChild(wrap);
        });
        host.appendChild(optionsWrap);

        toolbar.querySelector("#selectAllBtn").addEventListener("click", ()=>{
          host.querySelectorAll("input.panel-opt").forEach(ch => ch.checked = true);
        });
        toolbar.querySelector("#clearAllBtn").addEventListener("click", ()=>{
          host.querySelectorAll("input.panel-opt").forEach(ch => ch.checked = false);
        });

        $("#panelHint").textContent="Use Select all / Clear, then Save selection.";
      }

      $("#dashboard").classList.add("hidden");
      $("#panel").classList.remove("hidden");
    }

    function closePanel(save=false){
      if(save && ACTIVE_KEY){
        const meta=getMeta(ACTIVE_KEY);
        if(meta.type==="number"){
          const mn = ($("#wnumMin")?.value || "").trim();
          const mx = ($("#wnumMax")?.value || "").trim();
          const norm = (v)=> (v.toLowerCase && v.toLowerCase()==="x") ? "" : v;
          const a = norm(mn), b = norm(mx);
          if(a==="" && b==="") SELECTED[ACTIVE_KEY]=[];
          else SELECTED[ACTIVE_KEY]=[a,b];
        } else if (meta.type==="group"){
          if (ACTIVE_KEY === 'overige') {
            const tokens=[];
            const dmin= (document.getElementById('dateMin')?.value||'').trim();
            const dmax= (document.getElementById('dateMax')?.value||'').trim();
            if(dmin) tokens.push('date_min='+dmin);
            if(dmax) tokens.push('date_max='+dmax);
            document.querySelectorAll('#panelOptions .panel-opt-bool').forEach(ch=>{ if(ch.checked) tokens.push(ch.dataset.token); });
            SELECTED[ACTIVE_KEY]=tokens;
          } else {
            const tokens = [];
            $("#panelOptions").querySelectorAll("input.panel-opt-gd").forEach(ch=>{
              if(ch.checked) tokens.push(ch.dataset.token);
            });
            $("#panelOptions").querySelectorAll("input.panel-opt-bool").forEach(ch=>{
              if(ch.checked) tokens.push(ch.dataset.token);
            });
            const omin = ($("#oppMin")?.value || "").trim();
            const omax = ($("#oppMax")?.value || "").trim();
            const norm = (v)=> (v.toLowerCase && v.toLowerCase()==="x") ? "" : v;
            const a = norm(omin), b = norm(omax);
            if(a) tokens.push("oppmin=" + a);
            if(b) tokens.push("oppmax=" + b);
            SELECTED[ACTIVE_KEY] = tokens;
          }
        } else {
          const chosen=[];
          $("#panelOptions").querySelectorAll("input.panel-opt").forEach(ch=>{ if(ch.checked) chosen.push(ch.dataset.value); });
          SELECTED[ACTIVE_KEY]=chosen;
        }
      }
      ACTIVE_KEY=null;
      $("#panel").classList.add("hidden");
      $("#dashboard").classList.remove("hidden");
      renderDashboard();
    }

    async function loadFilters(){
      const res=await fetch(API("/api/filters"));
      const data=await res.json();
      FILTERS_META=data.filters||[];
      FILTER_OPTIONS=data.options||{};
      FILTERS_META.forEach(f=>{ if(!SELECTED[f.key]) SELECTED[f.key]=[]; });
      renderDashboard();
    }

    async function doPreview(){
      $("#previewOut").textContent="‚Ä¶";
      try{
        const res=await fetch(API("/api/preview"),{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({selected:SELECTED})
        });
        const data=await res.json();
        const count=typeof data.count==='number'?data.count:parseInt(data.count,10)||0;
        LAST_PREVIEW_COUNT=count;
        $("#previewOut").textContent=`${count.toLocaleString()} rows`;
      }catch(err){
        console.error('Preview failed',err);
        LAST_PREVIEW_COUNT=null;
        $("#previewOut").textContent="Error";
      }
      updateCustomSaveEstimate();
    }

    async function doDownload(){
      const res=await fetch(API("/api/download"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({selected:SELECTED})
      });
      const blob=await res.blob();
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download="filtered_results.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function toggleCustomSavePanel(){
      const panel=document.getElementById('customSavePanel');
      if(!panel) return;
      const hidden=panel.classList.contains('hidden');
      panel.classList.toggle('hidden',!hidden);
      if(hidden){
        setCustomSaveStatus('');
        updateCustomSaveEstimate();
      }
    }

    function updateCustomSaveEstimate(){
      const out=document.getElementById('customFileEstimate');
      if(!out) return;
      const input=document.getElementById('customMaxRows');
      const raw=(input && input.value?input.value:'').trim();
      if(!raw){ out.textContent='Enter max rows to estimate.'; return; }
      const maxRows=parseInt(raw,10);
      if(!Number.isFinite(maxRows)||maxRows<=0){ out.textContent='Max rows must be a positive number.'; return; }
      if(typeof LAST_PREVIEW_COUNT==='number'){
        const total=LAST_PREVIEW_COUNT;
        if(total<=0){ out.textContent='0 files (no rows to save).'; }
        else {
          const files=Math.ceil(total/maxRows);
          out.textContent=`${files} ${files===1?'file':'files'} from ${total.toLocaleString()} rows.`;
        }
      } else {
        out.textContent='Run a preview to estimate file count.';
      }
    }

    function setCustomSaveStatus(message,isError=false){
      const el=document.getElementById('customSaveStatus');
      if(!el) return;
      el.textContent=message||'';
      el.classList.toggle('status-error',!!isError);
    }

    async function doCustomSave(){
      const dir=(document.getElementById('customSavePath')?.value||'').trim();
      const base=(document.getElementById('customBaseName')?.value||'').trim();
      const raw=(document.getElementById('customMaxRows')?.value||'').trim();
      const btn=document.getElementById('customSaveRun');
      const maxRows=parseInt(raw,10);
      if(!dir){ setCustomSaveStatus('Provide a save directory.',true); return; }
      if(!base){ setCustomSaveStatus('Provide a base filename.',true); return; }
      if(!Number.isFinite(maxRows)||maxRows<=0){ setCustomSaveStatus('Max rows per file must be a positive number.',true); return; }
      setCustomSaveStatus('Saving‚Ä¶');
      if(btn) btn.disabled=true;
      try{
        const res=await fetch(API('/api/save'),{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({selected:SELECTED,directory:dir,baseName:base,maxRowsPerFile:maxRows})
        });
        let data={};
        try{ data=await res.json(); }catch(_){ data={}; }
        if(!res.ok || !data.ok) throw new Error(data.error||res.statusText||'Save failed');
        const files=Array.isArray(data.files)?data.files:[];
        const created=typeof data.created_files==='number'?data.created_files:files.length;
        const total=typeof data.total_rows==='number'?data.total_rows:null;
        let msg=`Saved ${created} file${created===1?'':'s'}`;
        if(typeof total==='number') msg+=` ¬∑ ${total.toLocaleString()} rows total`;
        setCustomSaveStatus(msg);
      }catch(err){
        console.error('Save failed',err);
        setCustomSaveStatus('Save failed: '+(err && err.message?err.message:err),true);
      }finally{
        if(btn) btn.disabled=false;
      }
    }

    document.addEventListener("DOMContentLoaded",()=>{
      loadFilters();
      $("#previewBtn").addEventListener("click",doPreview);
      $("#downloadBtn").addEventListener("click",doDownload);
      $("#customSaveToggle")?.addEventListener("click",(ev)=>{ ev.preventDefault(); toggleCustomSavePanel(); });
      $("#customMaxRows")?.addEventListener("input",updateCustomSaveEstimate);
      $("#customSaveRun")?.addEventListener("click",(ev)=>{ ev.preventDefault(); doCustomSave(); });
      $("#backBtn").addEventListener("click",()=>closePanel(false));
      $("#saveBtn").addEventListener("click",()=>closePanel(true));

      document.body.addEventListener("click",(e)=>{
        const xBtn = e.target.closest(".chip-x");
        if(xBtn && xBtn.dataset.clearkey){
          const k = xBtn.dataset.clearkey;
          if(SELECTED[k]) SELECTED[k] = [];
          renderDashboard();
          return;
        }
        const clrAll = e.target.closest("#clearAllBtn");
        if(clrAll){
          Object.keys(SELECTED).forEach(k => SELECTED[k]=[]);
          renderDashboard();
          return;
        }
      });
    });

  })();
  </script>
</body>
</html>
